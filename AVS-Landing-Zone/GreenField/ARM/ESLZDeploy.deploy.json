{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.34.44.8038",
      "templateHash": "17942774117958087453"
    }
  },
  "parameters": {
    "Prefix": {
      "type": "string",
      "defaultValue": "AVS",
      "minLength": 1,
      "maxLength": 20,
      "metadata": {
        "description": "The prefix to use on resources inside this template"
      }
    },
    "Location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "Optional: The location the private cloud should be deployed to, by default this will be the location of the deployment"
      }
    },
    "PrivateCloudAddressSpace": {
      "type": "string",
      "metadata": {
        "description": "The address space used for the AVS Private Cloud management networks. Must be a non-overlapping /22"
      }
    },
    "PrivateCloudSKU": {
      "type": "string",
      "defaultValue": "AV36P",
      "allowedValues": [
        "AV36",
        "AV36T",
        "AV36P",
        "AV36PT",
        "AV48",
        "AV52"
      ],
      "metadata": {
        "description": "The SKU that should be used for the first cluster, ensure you have quota for the given SKU before deploying"
      }
    },
    "Internet": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "Enabled"
      ],
      "metadata": {
        "description": "Optional: Connectivity to Internet through Managed SNAT Service"
      }
    },
    "PrivateCloudHostCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "The number of nodes to be deployed in the first/default cluster, ensure you have quota before deploying"
      }
    },
    "AddResourceLock": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional: Add a Resource Lock to the AVS Private Cloud."
      }
    },
    "AssignJumpboxAsAVSContributor": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional: Assign Jumpbox VM as Contributor on AVS Private Cloud"
      }
    },
    "VNetExists": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Set this to true if you are redeploying, and the VNet already exists"
      }
    },
    "VNetAddressSpace": {
      "type": "string",
      "metadata": {
        "description": "The address space used for the VNet attached to AVS. Must be non-overlapping with existing networks"
      }
    },
    "VNetGatewaySubnet": {
      "type": "string",
      "metadata": {
        "description": "The subnet CIDR used for the Gateway Subnet. Must be a /24 or greater within the VNetAddressSpace"
      }
    },
    "GatewayPIPAvailabilityZones": {
      "type": "array",
      "defaultValue": [
        "1",
        "2",
        "3"
      ],
      "metadata": {
        "description": "The availability zones to deploy the ExpressRoute Gateway Public IP."
      }
    },
    "GatewaySku": {
      "type": "string",
      "defaultValue": "ErGw1AZ",
      "metadata": {
        "description": "The SKU of the ExpressRoute Gateway."
      }
    },
    "AlertEmails": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Email addresses to be added to the alerting action group. Use the format [\"name1@domain.com\",\"name2@domain.com\"]."
      }
    },
    "DeployJumpbox": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should a Jumpbox & Bastion be deployed to access the Private Cloud"
      }
    },
    "JumpboxUsername": {
      "type": "string",
      "defaultValue": "avsjump",
      "metadata": {
        "description": "Username for the Jumpbox VM"
      }
    },
    "JumpboxPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Password for the Jumpbox VM, can be changed later"
      }
    },
    "JumpboxSubnet": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The subnet CIDR used for the Jumpbox VM Subnet. Must be a /26 or greater within the VNetAddressSpace"
      }
    },
    "JumpboxSku": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "The sku to use for the Jumpbox VM, must have quota for this within the target region"
      }
    },
    "OSVersion": {
      "type": "string",
      "defaultValue": "2022-datacenter-azure-edition-smalldisk",
      "allowedValues": [
        "2016-Datacenter",
        "2016-Datacenter-smalldisk",
        "2019-Datacenter",
        "2019-Datacenter-smalldisk",
        "2022-datacenter-azure-edition",
        "2022-datacenter-azure-edition-smalldisk"
      ],
      "metadata": {
        "description": "The OS Version for the Jumpbox VM. By default, it is Microsoft Windows Server 2012 Azure Edition with small disk for storage to reduce costs."
      }
    },
    "HighPerformance": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional: Enable high performance attributes for VM, such as setting Storage to Premium and enabling Accelerated Networking"
      }
    },
    "BootstrapJumpboxVM": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should run a bootstrap PowerShell script on the Jumpbox VM or not"
      }
    },
    "BootstrapPath": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/Azure/Enterprise-Scale-for-AVS/main/AVS-Landing-Zone/GreenField/Scripts/bootstrap.ps1",
      "metadata": {
        "description": "The path for Jumpbox VM bootstrap PowerShell script file (expecting \"bootstrap.ps1\" file)"
      }
    },
    "BootstrapCommand": {
      "type": "string",
      "defaultValue": "powershell.exe -ExecutionPolicy Unrestricted -File bootstrap.ps1",
      "metadata": {
        "description": "The command to trigger running the bootstrap script. If was not provided, then the expected script file name must be \"bootstrap.ps1\")"
      }
    },
    "JumpboxAvailabilityZone": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [
        "1"
      ],
      "allowedValues": [
        "1",
        "2",
        "3"
      ],
      "metadata": {
        "description": "The availability zone for the JumpBox VM."
      }
    },
    "BastionSubnet": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The subnet CIDR used for the Bastion Subnet. Must be a /26 or greater within the VNetAddressSpace"
      }
    },
    "DeployHCX": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should HCX be deployed as part of the deployment"
      }
    },
    "DeploySRM": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should SRM be deployed as part of the deployment"
      }
    },
    "SRMLicenseKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "License key to be used if SRM is deployed"
      }
    },
    "VRServerCount": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "Number of vSphere Replication Servers to be created if SRM is deployed"
      }
    },
    "TelemetryOptOut": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Opt-out of deployment telemetry"
      }
    }
  },
  "variables": {
    "deploymentPrefix": "[format('AVS-{0}', uniqueString(deployment().name, parameters('Location')))]",
    "varCuaid": "754599a0-0a6f-424a-b4c5-1b12be198ae8"
  },
  "resources": {
    "AVSCore": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-AVS', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "PrivateCloudAddressSpace": {
            "value": "[parameters('PrivateCloudAddressSpace')]"
          },
          "PrivateCloudHostCount": {
            "value": "[parameters('PrivateCloudHostCount')]"
          },
          "PrivateCloudSKU": {
            "value": "[parameters('PrivateCloudSKU')]"
          },
          "Internet": {
            "value": "[parameters('Internet')]"
          },
          "AddResourceLock": {
            "value": "[parameters('AddResourceLock')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "3364725779172448533"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "PrivateCloudAddressSpace": {
              "type": "string"
            },
            "PrivateCloudSKU": {
              "type": "string"
            },
            "PrivateCloudHostCount": {
              "type": "int"
            },
            "Internet": {
              "type": "string"
            },
            "AddResourceLock": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-PrivateCloud', deployment().name)]",
              "resourceGroup": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "NetworkBlock": {
                    "value": "[parameters('PrivateCloudAddressSpace')]"
                  },
                  "SKUName": {
                    "value": "[parameters('PrivateCloudSKU')]"
                  },
                  "ManagementClusterSize": {
                    "value": "[parameters('PrivateCloudHostCount')]"
                  },
                  "Internet": {
                    "value": "[parameters('Internet')]"
                  },
                  "AddResourceLock": {
                    "value": "[parameters('AddResourceLock')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "4786298112107190448"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "NetworkBlock": {
                      "type": "string"
                    },
                    "ManagementClusterSize": {
                      "type": "int"
                    },
                    "SKUName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Internet": {
                      "type": "string"
                    },
                    "AddResourceLock": {
                      "type": "bool"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}-SDDC', parameters('Prefix'))]",
                      "sku": {
                        "name": "[parameters('SKUName')]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "location": "[parameters('Location')]",
                      "properties": {
                        "networkBlock": "[parameters('NetworkBlock')]",
                        "internet": "[parameters('Internet')]",
                        "managementCluster": {
                          "clusterSize": "[parameters('ManagementClusterSize')]"
                        }
                      }
                    },
                    {
                      "condition": "[parameters('AddResourceLock')]",
                      "type": "Microsoft.Authorization/locks",
                      "apiVersion": "2020-05-01",
                      "scope": "[format('Microsoft.AVS/privateClouds/{0}', format('{0}-SDDC', parameters('Prefix')))]",
                      "name": "[format('{0}-SDDCLock', parameters('Prefix'))]",
                      "properties": {
                        "level": "CanNotDelete",
                        "notes": "Lock to prevent accidental deletion of the AVS Private Cloud"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.AVS/privateClouds', format('{0}-SDDC', parameters('Prefix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "PrivateCloudName": {
                      "type": "string",
                      "value": "[format('{0}-SDDC', parameters('Prefix'))]"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.AVS/privateClouds', format('{0}-SDDC', parameters('Prefix')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "PrivateCloudName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-PrivateCloud', deployment().name)), '2022-09-01').outputs.PrivateCloudName.value]"
            },
            "PrivateCloudResourceGroupName": {
              "type": "string",
              "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
            },
            "PrivateCloudResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-PrivateCloud', deployment().name)), '2022-09-01').outputs.PrivateCloudResourceId.value]"
            }
          }
        }
      }
    },
    "Networking": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-Network', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "VNetExists": {
            "value": "[parameters('VNetExists')]"
          },
          "VNetAddressSpace": {
            "value": "[parameters('VNetAddressSpace')]"
          },
          "VNetGatewaySubnet": {
            "value": "[parameters('VNetGatewaySubnet')]"
          },
          "GatewayPIPAvailabilityZones": {
            "value": "[parameters('GatewayPIPAvailabilityZones')]"
          },
          "GatewaySku": {
            "value": "[parameters('GatewaySku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "11461199715773641184"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "VNetExists": {
              "type": "bool"
            },
            "VNetAddressSpace": {
              "type": "string"
            },
            "VNetGatewaySubnet": {
              "type": "string"
            },
            "GatewaySku": {
              "type": "string"
            },
            "GatewayPIPAvailabilityZones": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Network', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-Network', deployment().name)]",
              "resourceGroup": "[format('{0}-Network', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "VNetExists": {
                    "value": "[parameters('VNetExists')]"
                  },
                  "VNetAddressSpace": {
                    "value": "[parameters('VNetAddressSpace')]"
                  },
                  "VNetGatewaySubnet": {
                    "value": "[parameters('VNetGatewaySubnet')]"
                  },
                  "GatewayPIPAvailabilityZones": {
                    "value": "[parameters('GatewayPIPAvailabilityZones')]"
                  },
                  "GatewaySku": {
                    "value": "[parameters('GatewaySku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "13386927955435249991"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "VNetExists": {
                      "type": "bool"
                    },
                    "VNetAddressSpace": {
                      "type": "string"
                    },
                    "VNetGatewaySubnet": {
                      "type": "string"
                    },
                    "GatewayPIPAvailabilityZones": {
                      "type": "array"
                    },
                    "GatewaySku": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "GatewayName": "[format('{0}-GW', parameters('Prefix'))]",
                    "VNetName": "[format('{0}-VNet', parameters('Prefix'))]"
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('VNetExists'))]",
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('VNetName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('VNetAddressSpace')]"
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[not(parameters('VNetExists'))]",
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', variables('VNetName'), 'GatewaySubnet')]",
                      "properties": {
                        "addressPrefix": "[parameters('VNetGatewaySubnet')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', variables('VNetName'))]"
                      ]
                    },
                    {
                      "condition": "[not(parameters('VNetExists'))]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}-PIP', variables('GatewayName'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Static"
                      },
                      "sku": {
                        "name": "Standard"
                      },
                      "zones": "[parameters('GatewayPIPAvailabilityZones')]"
                    },
                    {
                      "condition": "[not(parameters('VNetExists'))]",
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('GatewayName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "gatewayType": "ExpressRoute",
                        "sku": {
                          "name": "[parameters('GatewaySku')]",
                          "tier": "[parameters('GatewaySku')]"
                        },
                        "ipConfigurations": [
                          {
                            "name": "default",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('VNetName'), 'GatewaySubnet')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('VNetName'), 'GatewaySubnet')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetName": {
                      "type": "string",
                      "value": "[if(parameters('VNetExists'), variables('VNetName'), variables('VNetName'))]"
                    },
                    "GatewayName": {
                      "type": "string",
                      "value": "[if(parameters('VNetExists'), variables('GatewayName'), variables('GatewayName'))]"
                    },
                    "VNetResourceId": {
                      "type": "string",
                      "value": "[if(parameters('VNetExists'), resourceId('Microsoft.Network/virtualNetworks', variables('VNetName')), resourceId('Microsoft.Network/virtualNetworks', variables('VNetName')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Network', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "GatewayName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name)), '2022-09-01').outputs.GatewayName.value]"
            },
            "VNetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name)), '2022-09-01').outputs.VNetName.value]"
            },
            "VNetResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Network', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name)), '2022-09-01').outputs.VNetResourceId.value]"
            },
            "NetworkResourceGroup": {
              "type": "string",
              "value": "[format('{0}-Network', parameters('Prefix'))]"
            }
          }
        }
      }
    },
    "VNetConnection": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-VNet', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "GatewayName": {
            "value": "[reference('Networking').outputs.GatewayName.value]"
          },
          "NetworkResourceGroup": {
            "value": "[reference('Networking').outputs.NetworkResourceGroup.value]"
          },
          "VNetPrefix": {
            "value": "[parameters('Prefix')]"
          },
          "PrivateCloudName": {
            "value": "[reference('AVSCore').outputs.PrivateCloudName.value]"
          },
          "PrivateCloudResourceGroup": {
            "value": "[reference('AVSCore').outputs.PrivateCloudResourceGroupName.value]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "17189053592049946929"
            }
          },
          "parameters": {
            "VNetPrefix": {
              "type": "string"
            },
            "AVSPrefix": {
              "type": "string",
              "defaultValue": "[parameters('VNetPrefix')]"
            },
            "PrivateCloudResourceGroup": {
              "type": "string"
            },
            "PrivateCloudName": {
              "type": "string"
            },
            "NetworkResourceGroup": {
              "type": "string"
            },
            "GatewayName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-ExRAuth', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ConnectionName": {
                    "value": "[format('{0}-VNet', parameters('VNetPrefix'))]"
                  },
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "8083841088054014026"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "ConnectionName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/authorizations",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]",
                      "properties": {
                        "expressRouteId": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2023-03-01').circuit.expressRouteID]"
                      }
                    }
                  ],
                  "outputs": {
                    "ExpressRouteAuthorizationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName')), '2023-09-01').expressRouteAuthorizationKey]"
                    },
                    "ExpressRouteId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2023-03-01').circuit.expressRouteID]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-ExR', deployment().name)]",
              "resourceGroup": "[parameters('NetworkResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ConnectionName": {
                    "value": "[format('{0}-AVS', parameters('AVSPrefix'))]"
                  },
                  "GatewayName": {
                    "value": "[parameters('GatewayName')]"
                  },
                  "ExpressRouteAuthorizationKey": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExRAuth', deployment().name)), '2022-09-01').outputs.ExpressRouteAuthorizationKey.value]"
                  },
                  "ExpressRouteId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExRAuth', deployment().name)), '2022-09-01').outputs.ExpressRouteId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "5530705986593573498"
                    }
                  },
                  "parameters": {
                    "GatewayName": {
                      "type": "string"
                    },
                    "ConnectionName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ExpressRouteAuthorizationKey": {
                      "type": "securestring"
                    },
                    "ExpressRouteId": {
                      "type": "securestring"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('ConnectionName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "connectionType": "ExpressRoute",
                        "routingWeight": 0,
                        "virtualNetworkGateway1": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('GatewayName'))]",
                          "properties": {}
                        },
                        "peer": {
                          "id": "[parameters('ExpressRouteId')]"
                        },
                        "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]"
                      }
                    }
                  ],
                  "outputs": {
                    "ExRConnectionResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/connections', parameters('ConnectionName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExRAuth', deployment().name))]"
              ]
            }
          ],
          "outputs": {
            "ExRConnectionResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('NetworkResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExR', deployment().name)), '2022-09-01').outputs.ExRConnectionResourceId.value]"
            }
          }
        }
      },
      "dependsOn": [
        "AVSCore",
        "Networking"
      ]
    },
    "Addons": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-AVSAddons', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateCloudName": {
            "value": "[reference('AVSCore').outputs.PrivateCloudName.value]"
          },
          "PrivateCloudResourceGroup": {
            "value": "[reference('AVSCore').outputs.PrivateCloudResourceGroupName.value]"
          },
          "DeployHCX": {
            "value": "[parameters('DeployHCX')]"
          },
          "DeploySRM": {
            "value": "[parameters('DeploySRM')]"
          },
          "SRMLicenseKey": {
            "value": "[parameters('SRMLicenseKey')]"
          },
          "VRServerCount": {
            "value": "[parameters('VRServerCount')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "1843654544006741356"
            }
          },
          "parameters": {
            "PrivateCloudName": {
              "type": "string"
            },
            "PrivateCloudResourceGroup": {
              "type": "string"
            },
            "DeployHCX": {
              "type": "bool"
            },
            "DeploySRM": {
              "type": "bool"
            },
            "SRMLicenseKey": {
              "type": "string"
            },
            "VRServerCount": {
              "type": "int",
              "minValue": 1,
              "maxValue": 10
            }
          },
          "resources": [
            {
              "condition": "[parameters('DeployHCX')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-HCX', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11495491448702189745"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'hcx')]",
                      "properties": {
                        "addonType": "HCX",
                        "offer": "VMware MaaS Cloud Provider (Enterprise)"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('DeploySRM')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-SRM', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  },
                  "SRMLicenseKey": {
                    "value": "[parameters('SRMLicenseKey')]"
                  },
                  "VRServerCount": {
                    "value": "[parameters('VRServerCount')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "17513043880190293098"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "SRMLicenseKey": {
                      "type": "string"
                    },
                    "VRServerCount": {
                      "type": "int",
                      "minValue": 1,
                      "maxValue": 10
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'srm')]",
                      "properties": {
                        "licenseKey": "[parameters('SRMLicenseKey')]",
                        "addonType": "SRM"
                      }
                    },
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'vr')]",
                      "properties": {
                        "vrsCount": "[parameters('VRServerCount')]",
                        "addonType": "VR"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.AVS/privateClouds/addons', parameters('PrivateCloudName'), 'srm')]"
                      ]
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "AVSCore"
      ]
    },
    "Jumpbox": {
      "condition": "[parameters('DeployJumpbox')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-Jumpbox', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Username": {
            "value": "[parameters('JumpboxUsername')]"
          },
          "Password": {
            "value": "[parameters('JumpboxPassword')]"
          },
          "VNetName": {
            "value": "[reference('Networking').outputs.VNetName.value]"
          },
          "VNetResourceGroup": {
            "value": "[reference('Networking').outputs.NetworkResourceGroup.value]"
          },
          "BastionSubnet": {
            "value": "[parameters('BastionSubnet')]"
          },
          "JumpboxSubnet": {
            "value": "[parameters('JumpboxSubnet')]"
          },
          "JumpboxSku": {
            "value": "[parameters('JumpboxSku')]"
          },
          "OSVersion": {
            "value": "[parameters('OSVersion')]"
          },
          "HighPerformance": {
            "value": "[parameters('HighPerformance')]"
          },
          "BootstrapJumpboxVM": {
            "value": "[parameters('BootstrapJumpboxVM')]"
          },
          "BootstrapPath": {
            "value": "[parameters('BootstrapPath')]"
          },
          "BootstrapCommand": {
            "value": "[parameters('BootstrapCommand')]"
          },
          "JumpboxAvailabilityZone": {
            "value": "[parameters('JumpboxAvailabilityZone')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "10678295333343895005"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "Username": {
              "type": "securestring"
            },
            "Password": {
              "type": "securestring"
            },
            "VNetResourceGroup": {
              "type": "string"
            },
            "VNetName": {
              "type": "string"
            },
            "JumpboxSubnet": {
              "type": "string"
            },
            "JumpboxSku": {
              "type": "string"
            },
            "OSVersion": {
              "type": "string"
            },
            "HighPerformance": {
              "type": "bool"
            },
            "BootstrapJumpboxVM": {
              "type": "bool"
            },
            "BootstrapPath": {
              "type": "string"
            },
            "BootstrapCommand": {
              "type": "string"
            },
            "BastionSubnet": {
              "type": "string"
            },
            "JumpboxAvailabilityZone": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "resources": {
            "JumpboxResourceGroup": {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            "Subnet": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "Jumpbox-Subnet",
              "resourceGroup": "[parameters('VNetResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "VNetName": {
                    "value": "[parameters('VNetName')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "BastionSubnet": {
                    "value": "[parameters('BastionSubnet')]"
                  },
                  "JumpboxSubnet": {
                    "value": "[parameters('JumpboxSubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11973273517109272501"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "JumpboxSubnet": {
                      "type": "string"
                    },
                    "BastionSubnet": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2023-11-01",
                      "name": "JumpBoxNSG",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "securityRules": [
                          {
                            "name": "AllowAllInbond",
                            "properties": {
                              "protocol": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "direction": "Inbound",
                              "priority": 4000,
                              "sourcePortRange": "*",
                              "destinationPortRange": "*"
                            }
                          },
                          {
                            "name": "AllowAllOutbound",
                            "properties": {
                              "protocol": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "direction": "Outbound",
                              "priority": 4000,
                              "sourcePortRange": "*",
                              "destinationPortRange": "*"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'JumpBox')]",
                      "properties": {
                        "addressPrefix": "[parameters('JumpboxSubnet')]",
                        "networkSecurityGroup": {
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'JumpBoxNSG')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', 'JumpBoxNSG')]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'AzureBastionSubnet')]",
                      "properties": {
                        "addressPrefix": "[parameters('BastionSubnet')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'JumpBox')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "JumpBoxSubnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'JumpBox')]"
                    },
                    "BastionSubnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'AzureBastionSubnet')]"
                    }
                  }
                }
              }
            },
            "Bastion": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-Bastion', deployment().name)]",
              "resourceGroup": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "SubnetId": {
                    "value": "[reference('Subnet').outputs.BastionSubnetId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "15470368957662753987"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "SubnetId": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2020-05-01",
                      "name": "[format('{0}-bastion-pip', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Static"
                      }
                    },
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2020-05-01",
                      "name": "[format('{0}-bastion', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "IpConf",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('SubnetId')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-bastion-pip', parameters('Prefix')))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-bastion-pip', parameters('Prefix')))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "JumpboxResourceGroup",
                "Subnet"
              ]
            },
            "VM": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-VM', deployment().name)]",
              "resourceGroup": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "SubnetId": {
                    "value": "[reference('Subnet').outputs.JumpBoxSubnetId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Username": {
                    "value": "[parameters('Username')]"
                  },
                  "Password": {
                    "value": "[parameters('Password')]"
                  },
                  "VMSize": {
                    "value": "[parameters('JumpboxSku')]"
                  },
                  "OSVersion": {
                    "value": "[parameters('OSVersion')]"
                  },
                  "HighPerformance": {
                    "value": "[parameters('HighPerformance')]"
                  },
                  "BootstrapVM": {
                    "value": "[parameters('BootstrapJumpboxVM')]"
                  },
                  "BootstrapPath": {
                    "value": "[parameters('BootstrapPath')]"
                  },
                  "BootstrapCommand": {
                    "value": "[parameters('BootstrapCommand')]"
                  },
                  "JumpboxAvailabilityZone": {
                    "value": "[parameters('JumpboxAvailabilityZone')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "9701564664297558183"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "SubnetId": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Username": {
                      "type": "string"
                    },
                    "Password": {
                      "type": "securestring"
                    },
                    "VMSize": {
                      "type": "string"
                    },
                    "OSVersion": {
                      "type": "string"
                    },
                    "HighPerformance": {
                      "type": "bool"
                    },
                    "BootstrapVM": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "BootstrapPath": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "BootstrapCommand": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "JumpboxAvailabilityZone": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "variables": {
                    "Name": "[format('{0}-jumpbox', parameters('Prefix'))]",
                    "Hostname": "avsjumpbox"
                  },
                  "resources": {
                    "Nic": {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('SubnetId')]"
                              }
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": "[parameters('HighPerformance')]"
                      }
                    },
                    "VM": {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-03-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('VMSize')]"
                        },
                        "osProfile": {
                          "computerName": "[variables('Hostname')]",
                          "adminUsername": "[parameters('Username')]",
                          "adminPassword": "[parameters('Password')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "[parameters('OSVersion')]",
                            "version": "latest"
                          },
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[if(parameters('HighPerformance'), 'Premium_LRS', 'Standard_LRS')]"
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Name'))]"
                            }
                          ]
                        }
                      },
                      "zones": "[parameters('JumpboxAvailabilityZone')]",
                      "dependsOn": [
                        "Nic"
                      ]
                    },
                    "Bootstrap": {
                      "condition": "[parameters('BootstrapVM')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2015-06-15",
                      "name": "[format('{0}/CustomScriptExtension', variables('Name'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.9",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "fileUris": [
                            "[parameters('BootstrapPath')]"
                          ],
                          "commandToExecute": "[parameters('BootstrapCommand')]"
                        }
                      },
                      "dependsOn": [
                        "VM"
                      ]
                    }
                  },
                  "outputs": {
                    "JumpboxResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('Name'))]"
                    },
                    "JumpboxSAMIPrincipalId": {
                      "type": "string",
                      "value": "[reference('VM', '2021-03-01', 'full').identity.principalId]"
                    }
                  }
                }
              },
              "dependsOn": [
                "JumpboxResourceGroup",
                "Subnet"
              ]
            }
          },
          "outputs": {
            "JumpboxResourceId": {
              "type": "string",
              "value": "[reference('VM').outputs.JumpboxResourceId.value]"
            },
            "JumpboxSAMIPrincipalId": {
              "type": "string",
              "value": "[reference('VM').outputs.JumpboxSAMIPrincipalId.value]"
            }
          }
        }
      },
      "dependsOn": [
        "Networking"
      ]
    },
    "JumpboxAVSContributor": {
      "condition": "[and(parameters('DeployJumpbox'), parameters('AssignJumpboxAsAVSContributor'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-Contributor-Assignment', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateCloudName": {
            "value": "[reference('AVSCore').outputs.PrivateCloudName.value]"
          },
          "PrivateCloudResourceGroup": {
            "value": "[reference('AVSCore').outputs.PrivateCloudResourceGroupName.value]"
          },
          "JumpboxSAMIPrincipalId": {
            "value": "[reference('Jumpbox').outputs.JumpboxSAMIPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "675840380278960540"
            }
          },
          "parameters": {
            "PrivateCloudName": {
              "type": "string"
            },
            "PrivateCloudResourceGroup": {
              "type": "string"
            },
            "JumpboxSAMIPrincipalId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-Contributor-RBAC', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  },
                  "JumpboxSAMIPrincipalId": {
                    "value": "[parameters('JumpboxSAMIPrincipalId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "16888206450804303559"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "JumpboxSAMIPrincipalId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "contributorRoleDefinitionId": "b24988ac-6180-42a0-ab88-20f7382dd24c"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.AVS/privateClouds/{0}', parameters('PrivateCloudName'))]",
                      "name": "[guid(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), resourceGroup().id, variables('contributorRoleDefinitionId'))]",
                      "properties": {
                        "description": "Jumpbox VM Contributor role assignment on AVS Private Cloud",
                        "principalId": "[parameters('JumpboxSAMIPrincipalId')]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleDefinitionId'))]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "AVSCore",
        "Jumpbox"
      ]
    },
    "OperationalMonitoring": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-Monitoring', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AlertEmails": {
            "value": "[parameters('AlertEmails')]"
          },
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "PrimaryLocation": {
            "value": "[parameters('Location')]"
          },
          "PrimaryPrivateCloudName": {
            "value": "[reference('AVSCore').outputs.PrivateCloudName.value]"
          },
          "PrimaryPrivateCloudResourceId": {
            "value": "[reference('AVSCore').outputs.PrivateCloudResourceId.value]"
          },
          "JumpboxResourceId": "[if(parameters('DeployJumpbox'), createObject('value', reference('Jumpbox').outputs.JumpboxResourceId.value), createObject('value', ''))]",
          "VNetResourceId": {
            "value": "[reference('Networking').outputs.VNetResourceId.value]"
          },
          "ExRConnectionResourceId": {
            "value": "[reference('VNetConnection').outputs.ExRConnectionResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "5679419208707467943"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string"
            },
            "PrimaryLocation": {
              "type": "string"
            },
            "AlertEmails": {
              "type": "array"
            },
            "PrimaryPrivateCloudName": {
              "type": "string"
            },
            "PrimaryPrivateCloudResourceId": {
              "type": "string"
            },
            "JumpboxResourceId": {
              "type": "string"
            },
            "VNetResourceId": {
              "type": "string"
            },
            "ExRConnectionResourceId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Operational', parameters('Prefix'))]",
              "location": "[parameters('PrimaryLocation')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-ActionGroup', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "ActionGroupEmails": {
                    "value": "[parameters('AlertEmails')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "13366938563004525308"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "ActionGroupEmails": {
                      "type": "array",
                      "defaultValue": []
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/actionGroups",
                      "apiVersion": "2019-06-01",
                      "name": "[format('{0}-ActionGroup', parameters('Prefix'))]",
                      "location": "Global",
                      "properties": {
                        "copy": [
                          {
                            "name": "emailReceivers",
                            "count": "[length(parameters('ActionGroupEmails'))]",
                            "input": {
                              "emailAddress": "[parameters('ActionGroupEmails')[copyIndex('emailReceivers')]]",
                              "name": "[split(parameters('ActionGroupEmails')[copyIndex('emailReceivers')], '@')[0]]",
                              "useCommonAlertSchema": false
                            }
                          }
                        ],
                        "enabled": true,
                        "groupShortName": "[substring(format('avs{0}', uniqueString(parameters('Prefix'))), 0, 12)]"
                      }
                    }
                  ],
                  "outputs": {
                    "ActionGroupResourceId": {
                      "type": "string",
                      "value": "[resourceId('microsoft.insights/actionGroups', format('{0}-ActionGroup', parameters('Prefix')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-MetricAlerts', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActionGroupResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name)), '2022-09-01').outputs.ActionGroupResourceId.value]"
                  },
                  "AlertPrefix": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "17817930478413640175"
                    }
                  },
                  "parameters": {
                    "AlertPrefix": {
                      "type": "string"
                    },
                    "ActionGroupResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "Alerts": [
                      {
                        "Name": "CPU",
                        "Description": "CPU Usage per Cluster",
                        "Metric": "EffectiveCpuAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "CPUCritical",
                        "Description": "CPU Usage per Cluster (Critical)",
                        "Metric": "EffectiveCpuAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 95,
                        "Severity": 0
                      },
                      {
                        "Name": "Memory",
                        "Description": "Memory Usage per Cluster",
                        "Metric": "UsageAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "MemoryCritical",
                        "Description": "Memory Usage per Cluster (Critical)",
                        "Metric": "UsageAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 95,
                        "Severity": 0
                      },
                      {
                        "Name": "Storage",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 70,
                        "Severity": 2
                      },
                      {
                        "Name": "StorageCritical",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 75,
                        "Severity": 0
                      }
                    ]
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "MetricAlert",
                        "count": "[length(variables('Alerts'))]"
                      },
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[format('{0}-{1}', parameters('AlertPrefix'), variables('Alerts')[copyIndex()].Name)]",
                      "location": "Global",
                      "properties": {
                        "description": "[variables('Alerts')[copyIndex()].Description]",
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "name": "Metric1",
                              "operator": "GreaterThan",
                              "threshold": "[variables('Alerts')[copyIndex()].Threshold]",
                              "timeAggregation": "Average",
                              "criterionType": "StaticThresholdCriterion",
                              "metricName": "[variables('Alerts')[copyIndex()].Metric]",
                              "dimensions": [
                                {
                                  "name": "[variables('Alerts')[copyIndex()].SplitDimension]",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        "scopes": [
                          "[parameters('PrivateCloudResourceId')]"
                        ],
                        "severity": "[variables('Alerts')[copyIndex()].Severity]",
                        "evaluationFrequency": "PT5M",
                        "windowSize": "PT30M",
                        "autoMitigate": true,
                        "enabled": true,
                        "actions": [
                          {
                            "actionGroupId": "[parameters('ActionGroupResourceId')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-ServiceHealth', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActionGroupResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name)), '2022-09-01').outputs.ActionGroupResourceId.value]"
                  },
                  "AlertPrefix": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "3823460162029651791"
                    }
                  },
                  "parameters": {
                    "AlertPrefix": {
                      "type": "string"
                    },
                    "ActionGroupResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/activityLogAlerts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('{0}-ServiceHealth', parameters('AlertPrefix'))]",
                      "location": "Global",
                      "properties": {
                        "description": "Service Health Alerts",
                        "condition": {
                          "allOf": [
                            {
                              "field": "category",
                              "equals": "ServiceHealth"
                            },
                            {
                              "field": "properties.impactedServices[*].ServiceName",
                              "containsAny": [
                                "Azure VMware Solution"
                              ]
                            },
                            {
                              "field": "properties.impactedServices[*].ImpactedRegions[*].RegionName",
                              "containsAny": [
                                "[reference(parameters('PrivateCloudResourceId'), '2021-06-01', 'Full').location]",
                                "Global"
                              ]
                            }
                          ]
                        },
                        "scopes": [
                          "[subscription().id]"
                        ],
                        "enabled": true,
                        "actions": {
                          "actionGroups": [
                            {
                              "actionGroupId": "[parameters('ActionGroupResourceId')]"
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-Dashboard', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('PrimaryLocation')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  },
                  "JumpboxResourceId": {
                    "value": "[parameters('JumpboxResourceId')]"
                  },
                  "ExRConnectionResourceId": {
                    "value": "[parameters('ExRConnectionResourceId')]"
                  },
                  "VNetResourceId": {
                    "value": "[parameters('VNetResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "5288003934006589966"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "JumpboxResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    },
                    "VNetResourceId": {
                      "type": "string"
                    },
                    "ExRConnectionResourceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "DashboardHeading": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 1,
                        "x": 0,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MarkdownPart",
                        "inputs": [],
                        "settings": {
                          "content": {
                            "settings": {
                              "content": "# AVS Private Cloud Metrics",
                              "title": "",
                              "subtitle": "",
                              "markdownSource": 1
                            }
                          }
                        }
                      }
                    },
                    "EmptyJumpboxLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 10,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MarkdownPart",
                        "inputs": [],
                        "settings": {
                          "content": {
                            "settings": {
                              "content": "",
                              "title": "",
                              "subtitle": "",
                              "markdownSource": 1
                            }
                          }
                        }
                      }
                    },
                    "VNetLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 8,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/ResourcePart",
                        "asset": {
                          "idInputName": "id"
                        },
                        "inputs": [
                          {
                            "name": "id",
                            "value": "[parameters('VNetResourceId')]"
                          }
                        ]
                      }
                    },
                    "JumpboxLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 10,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/ResourcePart",
                        "asset": {
                          "idInputName": "id"
                        },
                        "inputs": [
                          {
                            "name": "id",
                            "value": "[parameters('JumpboxResourceId')]"
                          }
                        ]
                      }
                    },
                    "PrivateCloudLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 6,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/ResourcePart",
                        "asset": {
                          "idInputName": "id"
                        },
                        "inputs": [
                          {
                            "name": "id",
                            "value": "[parameters('PrivateCloudResourceId')]"
                          }
                        ]
                      }
                    },
                    "PrivateCloudCPUMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 0,
                        "y": 1
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('PrivateCloudResourceId')]"
                                    },
                                    "name": "EffectiveCpuAverage",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.avs/privateclouds",
                                    "metricVisualization": {
                                      "displayName": "Percentage CPU"
                                    }
                                  }
                                ],
                                "title": "Percentage CPU by Cluster Name",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "clustername",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "PrivateCloudDiskMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 6,
                        "y": 1
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('PrivateCloudResourceId')]"
                                    },
                                    "name": "DiskUsedPercentage",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.avs/privateclouds",
                                    "metricVisualization": {
                                      "displayName": " Percentage Datastore Disk Used"
                                    }
                                  }
                                ],
                                "title": "Percentage Datastore Disk Used by Datastore",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "dsname",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "PrivateCloudMemoryMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 0,
                        "y": 5
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('PrivateCloudResourceId')]"
                                    },
                                    "name": "UsageAverage",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.avs/privateclouds",
                                    "metricVisualization": {
                                      "displayName": "Average Memory Usage"
                                    }
                                  }
                                ],
                                "title": "Average Memory Usage by Cluster Name",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "clustername",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "ExpressRouteConnectionsMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 6,
                        "y": 5
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('ExRConnectionResourceId')]"
                                    },
                                    "name": "BitsInPerSecond",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.network/connections",
                                    "metricVisualization": {
                                      "displayName": "BitsInPerSecond"
                                    }
                                  },
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('ExRConnectionResourceId')]"
                                    },
                                    "name": "BitsOutPerSecond",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.network/connections",
                                    "metricVisualization": {
                                      "displayName": "BitsOutPerSecond"
                                    }
                                  }
                                ],
                                "title": "Private Cloud to VNet Utilization",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "dsname",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Portal/dashboards",
                      "apiVersion": "2019-01-01-preview",
                      "name": "[format('{0}-Dashboard', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "lenses": {
                          "0": {
                            "order": 0,
                            "parts": {
                              "0": "[variables('DashboardHeading')]",
                              "1": "[variables('PrivateCloudLink')]",
                              "2": "[if(empty(parameters('JumpboxResourceId')), variables('EmptyJumpboxLink'), variables('JumpboxLink'))]",
                              "3": "[variables('VNetLink')]",
                              "4": "[variables('PrivateCloudDiskMetric')]",
                              "5": "[variables('PrivateCloudCPUMetric')]",
                              "6": "[variables('PrivateCloudMemoryMetric')]",
                              "7": "[variables('ExpressRouteConnectionsMetric')]"
                            }
                          }
                        }
                      },
                      "tags": {
                        "hidden-title": "[format('{0}-Dashboard', parameters('Prefix'))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "AVSCore",
        "Jumpbox",
        "Networking",
        "VNetConnection"
      ]
    },
    "modCustomerUsageAttribution": {
      "condition": "[not(parameters('TelemetryOptOut'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('pid-{0}-{1}', variables('varCuaid'), uniqueString(deployment().name, parameters('Location')))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {},
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16726436052480137551"
            }
          },
          "resources": []
        }
      }
    }
  }
}