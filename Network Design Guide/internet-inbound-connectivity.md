# Design phase #3: Internet inbound connectivity
Design Phase #3 is driven by the requirements of the applications running on Azure VMware Solution that must be reachable over public IP addresses. Almost invariably, Internet-facing applications are published through network devices that provide security (next generation firewalls, web application firewalls) and load balancing (layer-3/layer-4 load balancers, application delivery controllers, â€¦) functions. Such devices can be deployed on the private cloud itself, or in an Azure VNet connected to the private cloud. Choosing between these two options is the main goal of Design Phase #3. The following considerations may help drive the decision:
-  Azure VMware Solution customers may want to leverage pre-existing NVAs deployed in Azure VNets (firewalls, application delivery controllers, ...) to publish applications running on their private cloud(s), for cost optimization and for consistency.
- Azure VMware Solution customers may want to leverage PaaS solutions available on Azure, to reduce management overhead. Azure services that can be used for publishing Internet-facing applications include [Azure Firewall](https://learn.microsoft.com/azure/firewall/tutorial-firewall-dnat) (both when deployed in a customer managed VNet and when deployed in a Virtual WAN Hub) and [Azure Application Gateway](https://learn.microsoft.com/azure/application-gateway/overview).
- Azure VMware Solution customers that prefer to host the network infrastructure for Internet publishing in their private cloud(s) may want to deploy firewalls and/or application delivery controllers as Azure VMware Solution virtual machines, if supported by the NVA vendor.

The flow chart below summarizes how to approach Phase #3:
 
![figure16](media/figure16.png) 
*Design Phase #3: Design outbound Internet connectivity based on where NVAs for application publishing will be hosted (Azure VMware Solution or Azure VNet).*

## NVAs for application publishing hosted in an Azure VNet
Publishing Azure VMware Solution applications via Azure first-party services (Azure Firewall, Azure Application Gateway) or third-party NVAs hosted in a VNet only requires layer-3 connectivity between the VNet and the private cloud (covered in section [Azure VNet connectivity](vnet-connectivity.md)). Azure VMware Solution applications are published behind Azure Public IP resources assigned to the first-party service or third-party NVAs. Standalone Public IPs, Public IPs from [Public Ip Prefixes](https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-address-prefix) or Public IPs from [Custom IP Prefixes (BYOIP)](https://learn.microsoft.com/azure/virtual-network/ip-services/custom-ip-address-prefix) can be used. The first-party services or the third-party NVAs can act either as layer-3/layer-4 devices (i.e. route/NAT connections to the application server VMs on Azure VMware Solution) or as layer-7 devices (i.e. reverse-proxy connections). In both cases, the application server VMs on Azure VMware Solution receive traffic destined to their private IP and originating from the publishing service/NVA's private IP. Routing-wise, this is traffic between virtual machines running in the private cloud and Azure virtual machines, which is dealt with by the implementation option chosen in [Design Phase #2](vnet-connectivity.md). 

### Considerations for Azure Firewall
[Azure Firewall](https://learn.microsoft.com/azure/firewall/overview) is the preferred option for exposing generic TCP or UDP endpoints through a first party layer-3/layer-4 device. To publish an Azure VMware Solution application through Azure Firewall, a DNAT rule must be configured, which maps the one of the firewall's public IPs to the Azure VMware Solution application endpoint's private IP. Azure Firewall automatically Source-NATs inbound connections from the Internet behind its private IP address. As a result, Azure VMware Solution virtual machines receive traffic whose source IP address is the Firewall's IP. Please refer to the official documentation for instructions on [how to configure DNAT rules on Azure Firewall](https://learn.microsoft.com/azure/firewall/tutorial-firewall-dnat). 

### Considerations for Azure Application Gateway
[Azure Application Gateway](https://learn.microsoft.com/azure/application-gateway/overview-v2) is the preferred option for exposing HTTP(S) applications running on Azure VMware Solution through a first-party layer-7 device with HTTP request routing and WAF capabilities. Application Gateway is an HTTP reverse proxy. It terminates TCP connections from the client and establishes upstream connections between itself and the target application servers. As a result, the application servers receive traffic whose source IP address is the Application Gateway's IP. It should be noted that the client's IP address can be carried in HTTP requests (typically, as a [custom "X-Forwarded-For" header](https://learn.microsoft.com/azure/application-gateway/how-application-gateway-works#modifications-to-the-request)) if the application logic requires access to such information. Please refer to the official documentation for instructions on [how to publish an Azure VMware Solution application through Application Gateway](https://learn.microsoft.com/azure/application-gateway/quick-create-portal)

> **Note** <br>
> Azure Application Gateway is currently the only supported first-party load balancer to expose web apps running on Azure VMware Solution VMs. This is because it allows pointing directly to the private IP addresses of VMs running on Azure VMware Solution when configuring its backend pool. In contrast, other load balancing services, such as Azure Load Balancer, do not allow this currently.

### Considerations for third-party NVAs
Third-party NVAs can provide layer-3/layer-4 firewall capabilities or layer-7 reverse-proxy/WAF capabilities. Guidance from the NVA vendor should be followed for deployment in Azure VNets. The main consideration when using third-party NVAs is that high availability is the user's responsibility. Detailed guidance on how to build highly-available clusters of NVAs in Azure is beyond the scope of this guide. The following high-level considerations are general enough to apply to any NVA technology:

- NVA clusters should be comprised of two or more **active** NVA instances (N-active HA model. Active/Passive HA should be avoided as it prevents horizontal scalability).
- Inbound Internet connections should be distributed to all running instances using a [Standard SKU Azure Load Balancer](https://learn.microsoft.com/azure/load-balancer/skus).  
- Layer-3/layer-4 NVAs must be configured to destination-NAT inbound Internet connections to the private IP of the Azure VMware Solution application(s) to be published.
- Layer-3/layer-4 NVAs must be configured to source-NAT inbound Internet connections behind their egress interface's private IP address, to preserve flow symmetry.  
- Layer-7 NVAs act as reverse-proxies and maintain two distinct TCP sessions for each inbound client connection: One between the client and the NVA and one between the NVA and the upstream application server. The latter session originates from the NVA egress interface's private IP address. HTTP(S) applications allow layer-7 NVAs to pass the client's public IP address to the application servers in HTTP request headers.

## NVAs for application publishing hosted in Azure VMware Solution (Public IPs on the NSX-T edge)
Publishing Azure VMware Solution applications via third-party NVAs deployed on Azure VMware Solution requires enabling [Public IPs on the NSX-T edge](https://learn.microsoft.com/azure/azure-vmware/enable-public-ip-nsx-edge) for the private cloud. The functionality associates Azure Public IPs from an [Azure Public IP Prefix](https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-address-prefix) to the private cloud and configures the Microsoft backbone to route Internet traffic destined those IPs to the private cloud's NSX-T T0/T1 gateways. T1 gateways can then be configured to destination-NAT inbound connections to the private IPs of NVAs attached to NSX-T segments. Detailed guidance for configuring Public IPs to the NSX-T edge and destination-NAT rules for inbound Internet connectivity is [available in the public doc](https://learn.microsoft.com/azure/azure-vmware/enable-public-ip-nsx-edge#inbound-internet-access-for-vms). When using Azure VMware Solution with Public IPs to the NSX-T edge, the following considerations apply:
- NAT should be done on T1 gateways, not on T0 gateways. In Azure VMware Solution private clouds, T0 gateways are active/active device pairs and, as such, cannot handle stateful NAT sessions. 
- Public IPs must be associated to an Azure Public IP Prefix. It is currently unsupported to use IPs from [Custom IP Prefixes (BYOIP)](https://learn.microsoft.com/azure/virtual-network/ip-services/custom-ip-address-prefix).
- When an Azure VMware Solution Private Cloud is configured with Public IPs to the NSX-T edge, a default route is installed in T0/T1 gateways, which routes outbound Internet connections via the Microsoft backbone's edge. As a result, using Public IPs on the NSX-T edge for Internet inbound connectivity also defines the implementation option for outbound connectivity, covered in the [next section](internet-outbound-connectivity.md).

## Next Steps
- Go to the next section to learn about [outbound internet connectivity](internet-outbound-connectivity.md)
- Go back to [Design Phase #2: Connectivity between Azure VMware Solution and Azure Virtual Networks](vnet-connectivity.md)
- Go back to the Azure VMware Solution Network Design Guide [introduction](readme.md)
